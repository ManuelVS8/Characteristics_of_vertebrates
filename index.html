<!DOCTYPE html>
<html lang="en" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Characteristics of Vertebrates</title>
<style>
  /* ====== VARIABLES Y BASE ====== */
  :root {
    --blue: #07145e;
    --blue-dark: #04032B;
    --blue-700: #1a3a5f;
    --blue-600: #254fba;
    --orange: #f59e42;
    --orange-700: #e67e22;
    --bg-grad-1: #1a3a5f;
    --bg-grad-2: #0d2340;
    --white: #ffffff;
    --green: #2ecc71;
    --red: #e74c3c;
    --panel: #E8EAFF;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--bg-grad-1) 0%, var(--bg-grad-2) 100%);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 15px;
  }

  .game-container {
    background: var(--white);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    padding: 1.5rem;
    max-width: 900px;
    width: 100%;
    min-height: 800px;
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .screen { display: none; animation: fadeIn 0.3s ease; flex: 1; flex-direction: column; }
  .screen.active { display: flex; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

  /* ====== ESTILOS PANTALLA DE INICIO ====== */
  h1 { color: var(--blue); text-align: center; font-size: clamp(1.8rem, 4.5vw, 2.5rem); font-weight: 900; letter-spacing: .5px; }
  .subtitle { color: var(--blue-700); text-align: center; font-size: clamp(1rem, 3vw, 1.25rem); margin-top: .25rem; }
  
  .advice-box { 
    background: var(--panel); 
    padding: 1rem 1.2rem; 
    border-radius: 12px; 
    color: var(--blue-700); 
    text-align: center;
    font-size: clamp(1rem, 3vw, 1.15rem);
    max-width: 760px;
    margin: 1rem auto;
    border-left: 4px solid var(--blue-700);
  }
  
  .hl { color: var(--orange); font-weight: 800; }

  .btn {
    background: var(--orange);
    color: white;
    border: none;
    padding: 0.8rem 2rem;
    border-radius: 10px;
    font-weight: 800;
    cursor: pointer;
    font-size: 1.1rem;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin: 10px auto;
    min-width: 220px;
  }
  .btn:hover { background: var(--orange-700); transform: scale(1.02); }

  /* ====== ESTILOS PANTALLA FINAL ====== */
  .final-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
    padding: 1rem;
  }
  .final-score-label { font-size: 1.0rem; color: var(--blue-700); margin-top: 1rem; }
  .big-score { font-size: clamp(2.2rem, 6vw, 3.4rem); color: var(--blue-600); font-weight: 900; }
  .final-msg-style {
    color: var(--blue-dark);
    font-weight: 800;
    font-size: clamp(1.4rem, 4vw, 1.8rem);
    margin: 0.5rem 0 1rem;
    line-height: 1.4;
  }
  .final-time { color: var(--blue-700); font-size: 1.1rem; margin-bottom: 1rem; }
  .credit { color: var(--blue-700); margin-top: 1rem; font-weight: bold; }
  .school-logo { display: block; margin: 1rem auto 0; max-width: 160px; height: auto; }
  .trophy { font-size: clamp(4rem, 10vw, 6rem); margin: .2rem 0; color: var(--orange); animation: bounce 1s ease infinite; display: none; }
  @keyframes bounce { 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-8px);} }

  /* ====== ESTILOS COMUNES Y DE JUEGO (Sin modificar l√≥gica) ====== */
  .summary-img { width: 100%; height: auto; border-radius: 8px; border: 1px solid #eee; margin: 10px 0; display: block; }

  .mute-btn {
    position: absolute; top: 15px; right: 15px;
    background: var(--white); border: 2px solid var(--orange);
    border-radius: 50%; width: 40px; height: 40px; cursor: pointer; z-index: 2000;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
  }

  .progress-container { width: 100%; height: 12px; background: #eee; border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
  .progress-bar { height: 100%; background: var(--orange); width: 0%; transition: width 0.4s; }

  /* √ÅREA DE PREGUNTAS: Gesti√≥n de superposici√≥n */
  #questionsArea { 
    position: relative;
    margin-bottom: 20px;
    flex-grow: 1;
  }

  .question-block { 
    background: #fdfdfd; 
    padding: 1rem; 
    border-radius: 10px; 
    margin-bottom: 1rem;
    border: 1px solid #eee;
    border-left: 5px solid var(--orange);
    position: relative; /* Contexto de posicionamiento */
  }

  /* Z-INDEX INVERSO: La primera pregunta est√° "m√°s arriba" en profundidad que la segunda */
  .question-block:nth-child(1) { z-index: 100; }
  .question-block:nth-child(2) { z-index: 90; }
  .question-block:nth-child(3) { z-index: 80; }
  .question-block:nth-child(4) { z-index: 70; }

  .question-text { font-weight: 700; color: var(--blue-dark); margin-bottom: 8px; }
  
  .custom-select-wrapper { position: relative; width: 100%; }
  .select-label { font-size: 0.8rem; color: var(--blue-600); font-weight: 900; margin-bottom: 4px; display: block; }
  
  .custom-select {
    background: white; border: 2px solid #ddd; border-radius: 8px;
    padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600;
  }
  .custom-select.correct { border-color: var(--green); background: #e8f8ef; }
  .custom-select.incorrect { border-color: var(--red); background: #fdeaea; }

  /* LISTA DESPLEGABLE: Superposici√≥n absoluta */
  .options-list {
    position: absolute; 
    top: 100%; 
    left: 0; 
    right: 0;
    background: white; 
    border: 2px solid var(--blue-600); 
    border-radius: 0 0 8px 8px;
    z-index: 999; /* Muy alto dentro de su contenedor padre */
    max-height: 0; 
    overflow: hidden; 
    transition: max-height 0.2s ease-in-out;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .options-list.open { max-height: 250px; overflow-y: auto; }
  .option-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; color: var(--blue-dark); }
  .option-item:hover { background: var(--panel); }

  /* Hall of Fame (Estilo solicitado) */
  .hall-of-fame { background: var(--panel); border-radius: 12px; padding: 1rem; margin-top: 1rem; width: 100%; max-width: 600px; align-self: center; }
  .hall-of-fame-title { color: var(--blue-700); font-weight: 800; text-align: center; margin-bottom: 0.8rem; }
  .hall-of-fame-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
  .hall-of-fame-table th { background: var(--blue-600); color: white; padding: 0.5rem; text-align: left; }
  .hall-of-fame-table td { padding: 0.4rem 0.5rem; border-bottom: 1px solid #ddd; }
  .hall-of-fame-table tr:last-child td { border-bottom: none; }
  .hall-of-fame-table tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.5); }

  /* Confetti */
  .confetti { position: fixed; width: 10px; height: 10px; border-radius: 50%; animation: confetti-fall 3s linear forwards; z-index: 999; }
  @keyframes confetti-fall{ 0%{ transform:translate(0, -20px) rotate(0); opacity:1;} 100%{ transform:translate(var(--tx), var(--ty)) rotate(360deg); opacity:0; } }

</style>
</head>
<body>

<div class="game-container">
  <button class="mute-btn" id="muteBtn">üîä</button>

  <!-- PANTALLA DE INICIO -->
  <section id="startScreen" class="screen active">
    <header>
      <h1>Characteristics of Vertebrates</h1>
      <div class="subtitle">Identify the characteristics of vertebrate animals</div>
    </header>
    
    <div class="advice-box">
      Remember: vertebrates are classified according to their characteristics: <span class="hl">limbs</span>, <span class="hl">skin</span>, <span class="hl">breathing</span> and <span class="hl">reproduction</span>.<br>
      <strong>Good luck!</strong>
    </div>

    <!-- Imagen de Ni√±os (Debajo del consejo) -->
    <div style="text-align:center; margin: 1rem 0;">
      <img src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Ni%C3%B1os.png" 
           style="max-width:280px; width:100%; display:block; margin:0 auto;" 
           alt="Children learning">
    </div>

    <button class="btn" id="playBtn">Start</button>
    
    <!-- Hall of Fame -->
    <div class="hall-of-fame">
      <div class="hall-of-fame-title">üèÜ Best Scores üèÜ</div>
      <table class="hall-of-fame-table">
        <thead>
          <tr>
            <th>Pos</th>
            <th>Name</th>
            <th>Points</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="hofTableBody"></tbody>
      </table>
      <div id="hofLoading" style="text-align:center; padding:5px;">Loading best scores...</div>
    </div>
  </section>

  <!-- PANTALLA RESUMEN (Game Summary) -->
  <section id="summaryScreen" class="screen">
    <h1>Study the characteristics of vertebrate animals</h1>
    <!-- Aqu√≠ va la imagen del resumen de vertebrados -->
    <img src="https://raw.githubusercontent.com/ManuelVS8/Audios-juegos-SCIENCE/refs/heads/main/Animales_y_Plantas/Characteristics_vertebrates.png" class="summary-img" alt="Summary">
    <button class="btn" id="toGameBtn">Play Game</button>
  </section>

  <!-- PANTALLA DE JUEGO (Sin modificar estilo ni l√≥gica) -->
  <section id="gameScreen" class="screen">
    <h1 id="groupTitle">...</h1>
    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>
    <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--blue-700); margin-bottom:10px;">
      <span id="levelIndicator">Loading...</span>
      <span id="gameTimer">00:00.0</span>
    </div>
    
    <div id="questionsArea"></div>
    
    <div style="text-align:center;">
      <button class="btn" id="checkBtn">Check Answers</button>
    </div>
  </section>

  <!-- PANTALLA FINAL (Como a m√≠ me gusta) -->
  <section id="finalScreen" class="screen" style="text-align:center;">
    <header>
      <h1>Characteristics of Vertebrates</h1>
    </header>
    <div class="final-container">
      <div class="trophy" id="trophyBox">üèÜ</div>
      <div class="final-score-label">Score:</div>
      <div class="big-score" id="finalScoreDisplay">0</div>
      <div id="finalMsg" class="final-msg-style"></div>
      <div class="final-time">Time taken: <span id="finalTimeDisplay">00:00.0</span></div>
      
      <button class="btn" id="restartBtn">Back to Menu</button>
      
      <p class="credit">Created by Manuel J. Ventura</p>
      <img src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Siurot.png" class="school-logo" alt="School Logo" />
    </div>
  </section>
</div>

<!-- MODAL PARA GUARDAR PUNTUACI√ìN -->
<div id="submitModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; justify-content:center; align-items:center; z-index:5000;">
  <div style="background:white; padding:2rem; border-radius:20px; text-align:center; width:90%; max-width:400px;">
    <h3 style="color:var(--blue); margin-bottom:15px;">Game Finished!</h3>
    <p>Time: <span id="modalTime"></span> | Points: <span id="modalScore"></span></p>
    <input type="text" id="playerName" style="width:100%; padding:12px; margin:8px 0; border:2px solid #ddd; border-radius:10px;" placeholder="Your Name">
    <input type="text" id="playerSurname" style="width:100%; padding:12px; margin:8px 0; border:2px solid #ddd; border-radius:10px;" placeholder="Your Surname">
    <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
        <button class="btn btn-ghost" id="discardScoreBtn" style="background:#eee; color:#555; min-width:100px;">Cancel</button>
        <button class="btn" id="submitScoreBtn" style="min-width:100px;">Save</button>
    </div>
  </div>
</div>

<script>
const SHEET_NAME = "Caracteristicas";
const APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbu0fcjUhXKQ0sbUkNOx4YhfUno7mif5clU3lBipogFsCtq7UytDrEW8NbTXBvM0LCPQ/exec";

const GROUPS = [
  { name: "MAMMALS", questions: [
    {q:"How do they move?", t:"Limbs", a:"Legs"},
    {q:"What is their skin covered with?", t:"Skin", a:"Hair"},
    {q:"How do they breathe?", t:"Breathing", a:"Lungs"},
    {q:"How are they born?", t:"Reproduction", a:"Viviparous"}
  ]},
  { name: "BIRDS", questions: [
    {q:"How do they move?", t:"Limbs", a:"Legs and wings"},
    {q:"What is their skin covered with?", t:"Skin", a:"Feathers"},
    {q:"How do they breathe?", t:"Breathing", a:"Lungs"},
    {q:"How are they born?", t:"Reproduction", a:"Oviparous"}
  ]},
  { name: "REPTILES", questions: [
    {q:"How do they move?", t:"Limbs", a:"Legs"},
    {q:"What is their skin covered with?", t:"Skin", a:"Scales"},
    {q:"How do they breathe?", t:"Breathing", a:"Lungs"},
    {q:"How are they born?", t:"Reproduction", a:"Oviparous"}
  ]},
  { name: "FISH", questions: [
    {q:"How do they move?", t:"Limbs", a:"Fins"},
    {q:"What is their skin covered with?", t:"Skin", a:"Scales"},
    {q:"How do they breathe?", t:"Breathing", a:"Gills"},
    {q:"How are they born?", t:"Reproduction", a:"Oviparous"}
  ]},
  { name: "AMPHIBIANS", questions: [
    {q:"How do they move?", t:"Limbs", a:"Legs"},
    {q:"What is their skin covered with?", t:"Skin", a:"Moist skin"},
    {q:"How do they breathe?", t:"Breathing", a:"Gills (young) and lungs (adults)"},
    {q:"How are they born?", t:"Reproduction", a:"Oviparous"}
  ]}
];

const OPTS = {
  Limbs: ["Legs", "Legs and wings", "Fins"],
  Skin: ["Hair", "Feathers", "Scales", "Moist skin"],
  Breathing: ["Lungs", "Gills", "Gills (young) and lungs (adults)"],
  Reproduction: ["Viviparous", "Oviparous"]
};

let currentIdx = 0, score = 0, gameGroups = [], timerInt, startTime, isMuted = false, isHofLoading = false;

const sounds = {
  correcto: new Audio("https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Correcto.mp3"),
  error: new Audio("https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Error.mp3"),
  victoria: new Audio("https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Termin%C3%A9.mp3"),
  completado: new Audio("https://github.com/ManuelVS8/Efectos_audio/raw/7b86808e254100aeaba6285b3e0b82650ae78055/Completado.mp3"),
  tap: new Audio("https://github.com/ManuelVS8/Efectos_audio/raw/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3")
};

const el = id => document.getElementById(id);

// Reproducir sonido con clonaci√≥n para permitir clicks r√°pidos
const playS = k => { 
  if(!isMuted) { 
    const s = sounds[k].cloneNode(true); 
    s.currentTime = 0; 
    s.play().catch(()=>{}); 
  } 
};

function showS(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); el(id).classList.add('active'); }

el('playBtn').onclick = () => { playS('tap'); showS('summaryScreen'); };
el('toGameBtn').onclick = () => { playS('tap'); initG(); };

function initG() {
  currentIdx = 0; score = 0;
  gameGroups = [...GROUPS].sort(()=>Math.random()-0.5);
  startTime = Date.now();
  timerInt = setInterval(updateT, 100);
  loadL();
  showS('gameScreen');
}

function updateT() {
  const d = (Date.now() - startTime)/1000;
  const m = Math.floor(d/60).toString().padStart(2,'0');
  const s = Math.floor(d%60).toString().padStart(2,'0');
  const dec = Math.floor((d%1)*10);
  el('gameTimer').textContent = `${m}:${s}.${dec}`;
}

function loadL() {
  const g = gameGroups[currentIdx];
  el('groupTitle').innerHTML = `Group: <span class="hl">${g.name}</span>`;
  el('levelIndicator').textContent = `Level ${currentIdx+1} of 5`;
  el('progressBar').style.width = `${(currentIdx/5)*100}%`;
  
  const qArea = el('questionsArea');
  qArea.innerHTML = '';
  g.questions.forEach((q, index) => {
    const div = document.createElement('div');
    div.className = 'question-block';
    div.innerHTML = `
      <p class="question-text">${q.q}</p>
      <span class="select-label">${q.t.toUpperCase()}</span>
      <div class="custom-select-wrapper">
        <div class="custom-select" onclick="openSel(this)" data-ans="${q.a}">
          <span>Choose an option...</span><span>‚ñº</span>
        </div>
        <div class="options-list">
          ${OPTS[q.t].map(o => `<div class="option-item" onclick="setSel(this,'${o}')">${o}</div>`).join('')}
        </div>
      </div>
    `;
    qArea.appendChild(div);
  });
  el('checkBtn').disabled = false;
}

function openSel(e) {
  if(e.classList.contains('correct')) return;
  const list = e.nextElementSibling;
  const isOpen = list.classList.contains('open');
  document.querySelectorAll('.options-list').forEach(l=>l.classList.remove('open'));
  if(!isOpen) {
    playS('tap');
    list.classList.add('open');
  }
}

function setSel(e, v) {
  const wrapper = e.closest('.custom-select-wrapper');
  const select = wrapper.querySelector('.custom-select');
  select.querySelector('span').textContent = v;
  select.dataset.val = v;
  wrapper.querySelector('.options-list').classList.remove('open');
  playS('tap');
}

el('checkBtn').onclick = () => {
  const selects = document.querySelectorAll('.custom-select');
  let allSelected = true;
  selects.forEach(s => { if(!s.dataset.val) allSelected = false; });
  if(!allSelected) return alert("Answer all questions!");

  el('checkBtn').disabled = true;
  let levelPerfect = true;
  selects.forEach(s => {
    if(s.dataset.val === s.dataset.ans) {
      s.classList.add('correct');
      score +=5;
    } else {
      s.classList.add('incorrect');
      levelPerfect = false;
    }
  });

  playS(levelPerfect ? 'correcto' : 'error');
  
  setTimeout(() => {
    currentIdx++;
    if(currentIdx < 5) loadL();
    else finishG();
  }, 1500);
};

function finishG() {
  clearInterval(timerInt);
  el('finalScoreDisplay').textContent = score;
  el('finalTimeDisplay').textContent = el('gameTimer').textContent;
  const msg = el('finalMsg');
  const trophy = el('trophyBox');
  
  // L√≥gica de Puntuaci√≥n y Mensajes Solicitada
  if(score === 100) {
    msg.textContent = "Amazing! Perfect score!";
    trophy.style.display = "block";
    playS('victoria');
    spawnConfetti();
  } else if (score >= 80) {
    msg.textContent = "So close! Keep practising!";
    trophy.style.display = "none";
    playS('completado');
  } else if (score >= 50) {
    msg.textContent = "Not bad, but you can still do better";
    trophy.style.display = "none";
    playS('completado');
  } else {
    msg.textContent = "What a disaster... Are you sure you studied?";
    trophy.style.display = "none";
    playS('completado');
  }

  showS('finalScreen');
  
  setTimeout(() => { 
    el('modalTime').textContent = el('finalTimeDisplay').textContent;
    el('modalScore').textContent = score;
    el('submitModal').style.display = 'flex'; 
  }, 1000);
}

// Efecto Confeti
function spawnConfetti(){
  for(let i=0;i<120;i++){
    setTimeout(()=>{
      const c=document.createElement('div'); c.className='confetti';
      const x=Math.random()*window.innerWidth;
      const ty=window.innerHeight+20;
      const tx=(Math.random()-.5)*160;
      const colors=['#ff595e','#1982c4','#6a4c93','#ffca3a','#8ac926','#ff924c','#00c2ff'];
      c.style.left=x+'px'; c.style.top='-10px';
      c.style.backgroundColor=colors[Math.floor(Math.random()*colors.length)];
      const size=6+Math.random()*8; c.style.width=size+'px'; c.style.height=size+'px';
      c.style.setProperty('--tx', tx+'px'); c.style.setProperty('--ty', ty+'px');
      document.body.appendChild(c);
      setTimeout(()=>c.remove(), 3200);
    }, i*18);
  }
}

// Hall of Fame Logic
async function loadHof() {
  if(isHofLoading) return;
  isHofLoading = true;
  const b = el('hofTableBody');
  b.innerHTML = '';
  try {
    const r = await fetch(`${APP_SCRIPT_URL}?action=read&sheet=${SHEET_NAME}&t=${Date.now()}`);
    const d = await r.json();
    if(d.status === 'success') {
      el('hofLoading').style.display = 'none';
      d.data.slice(0, 10).forEach((row, i) => {
        const tr = document.createElement('tr');
        const timeVal = parseFloat(row.time);
        const timeStr = `${Math.floor(timeVal/60).toString().padStart(2,'0')}:${Math.floor(timeVal%60).toString().padStart(2,'0')}.${Math.floor((timeVal%1)*10)}`;
        tr.innerHTML = `<td>${i+1}</td><td>${row.name}</td><td>${row.score}</td><td>${timeStr}</td>`;
        b.appendChild(tr);
      });
    }
  } catch(e) { el('hofLoading').textContent = "Error loading ranking"; }
  finally { isHofLoading = false; }
}

el('submitScoreBtn').onclick = async () => {
  const name = el('playerName').value.trim();
  const surname = el('playerSurname').value.trim();
  if(!name || !surname) return alert("Enter your name and surname");
  
  const tStr = el('finalTimeDisplay').textContent.split(/[:.]/);
  const totalS = (parseInt(tStr[0])*60) + parseInt(tStr[1]) + (parseInt(tStr[2])/10);

  el('submitScoreBtn').disabled = true;
  el('submitScoreBtn').textContent = "Sending...";

  try {
    await fetch(APP_SCRIPT_URL, {
      method: 'POST', mode: 'no-cors',
      headers: {'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({sheet: SHEET_NAME, action: 'write', data: {score, time: totalS, name: `${name} ${surname}`}})
    });
    el('submitModal').style.display = 'none';
    loadHof();
  } catch(e) { alert("Error saving"); }
  finally {
    el('submitScoreBtn').disabled = false;
    el('submitScoreBtn').textContent = "Save";
  }
};

el('muteBtn').onclick = () => { isMuted = !isMuted; el('muteBtn').textContent = isMuted ? 'üîá' : 'üîä'; };
el('discardScoreBtn').onclick = () => { playS('tap'); el('submitModal').style.display = 'none'; };
el('restartBtn').onclick = () => { playS('tap'); location.reload(); };

window.onload = loadHof;
</script>
</body>
</html>